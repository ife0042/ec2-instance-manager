<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EC2 Instance Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-badge {
            font-size: 1.2em;
            min-width: 100px;
        }
        .server-ip {
            font-family: monospace;
            font-size: 1.2em;
        }
        @media (max-width: 576px) {
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">EC2 Instance Manager</h1>
        
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Instance Configuration</h5>
                <div class="mb-3">
                    <label for="instance-id" class="form-label">Instance ID</label>
                    <input type="text" class="form-control" id="instance-id" placeholder="Enter instance ID (leave empty for default)">
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Instance Status</h5>
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <span class="status-badge badge" id="status-badge">Checking...</span>
                    </div>
                    <div class="col-md-8">
                        <div class="server-ip">
                            IP: <a href="#" id="server-ip" target="_blank">Checking...</a>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <button class="btn btn-success d-block d-sm-inline mb-4 me-2" id="start-btn" disabled>Start Server</button>
                    <button class="btn btn-danger d-block d-sm-inline mb-4 me-2" id="stop-btn" disabled>Stop Server</button>
                    <button class="btn btn-info d-block d-sm-inline mb-4" id="refresh-btn">Refresh Status</button>
                </div>
            </div>
        </div>

        <!-- Add log section -->
        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title">Action Log</h5>
                <div class="log-container" style="max-height: 300px; overflow-y: auto;">
                    <ul class="list-unstyled" id="action-log">
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Add Bootstrap JS for toast functionality and wait for it to load
        const toastScript = document.createElement('script');
        toastScript.src = 'https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js';
        toastScript.onload = () => {
            // Initialize everything after Bootstrap is loaded
            initializeApp();
        };
        document.head.appendChild(toastScript);

        function initializeApp() {
            const MAX_LOG_ENTRIES = 1000;
            const actionLog = document.getElementById('action-log');
            const instanceIdInput = document.getElementById('instance-id');

            function getInstanceIdParam() {
                const instanceId = instanceIdInput.value.trim();
                return instanceId ? `?instance_id=${instanceId}` : '';
            }

            function addLogEntry(action, status="") {
                const now = new Date();
                console.log(now);
                const timeString = now.toLocaleString('en-US', { 
                    timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    dateStyle: 'medium',
                    timeStyle: 'medium'
                });
                const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                
                const logEntry = document.createElement('li');
                logEntry.className = 'mb-2';
                // logEntry.innerHTML = `
                //     <small class="text-muted">[${timeString} (${timezone})] [${status}] ${action}</small>
                // `;
                logEntry.innerHTML = `
                    <small class="${status==='success' ? 'text-success' : 'text-danger'}">[${now}] [${status}] ${action}</small>
                `;

                actionLog.prepend(logEntry);

                // Remove old entries if exceeding MAX_LOG_ENTRIES
                while (actionLog.children.length > MAX_LOG_ENTRIES) {
                    actionLog.removeChild(actionLog.lastChild);
                }
            }

            function updateStatus() {
                fetch(`/api/status${getInstanceIdParam()}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            updateUI(data);
                            addLogEntry('Status check successful', 'success');
                        } else {
                            showError(data.message);
                            addLogEntry('Status check failed', 'failed');
                        }
                    })
                    .catch(error => {
                        showError('Failed to fetch status');
                        addLogEntry('Status check failed', 'failed');
                    });
            }

            function updateUI(data) {
                const statusBadge = document.getElementById('status-badge');
                const startBtn = document.getElementById('start-btn');
                const stopBtn = document.getElementById('stop-btn');
                const serverIp = document.getElementById('server-ip');

                // Update status badge
                statusBadge.textContent = data.state;
                statusBadge.className = 'status-badge badge';
                switch (data.state) {
                    case 'running':
                        statusBadge.classList.add('bg-success');
                        startBtn.disabled = true;
                        stopBtn.disabled = false;
                        break;
                    case 'stopped':
                        statusBadge.classList.add('bg-danger');
                        startBtn.disabled = false;
                        stopBtn.disabled = true;
                        break;
                    default:
                        statusBadge.classList.add('bg-warning');
                        startBtn.disabled = true;
                        stopBtn.disabled = true;
                }

                // Update IP address
                if (data.public_ip !== 'Not available') {
                    serverIp.textContent = data.public_ip;
                    serverIp.href = `http://${data.public_ip}`;
                } else {
                    serverIp.textContent = 'Not available';
                    serverIp.href = '#';
                }
            }

            function showError(message) {
                console.error(message);
                // You could add a toast or alert here
            }

            document.getElementById('start-btn').addEventListener('click', () => {
                fetch(`/api/start${getInstanceIdParam()}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            addLogEntry('Server started successfully', 'success');
                            setTimeout(updateStatus, 2000);
                        } else {
                            addLogEntry('Server start failed', 'failed');
                            showError(data.message);
                        }
                    });
            });

            document.getElementById('stop-btn').addEventListener('click', () => {
                fetch(`/api/stop${getInstanceIdParam()}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            addLogEntry('Server stopped successfully', 'success');
                            setTimeout(updateStatus, 2000);
                        } else {
                            addLogEntry('Server stop failed', 'failed');
                            showError(data.message);
                        }
                    });
            });

            document.getElementById('refresh-btn').addEventListener('click', updateStatus);

            // Add instance ID change handler
            instanceIdInput.addEventListener('change', updateStatus);
            
            // Add Enter key handler for instance ID input
            instanceIdInput.addEventListener('keyup', (event) => {
                if (event.key === 'Enter') {
                    updateStatus();
                }
            });

            // Initial status check
            updateStatus();
            // Periodic status update
            setInterval(updateStatus, 30000);
        }
    </script>
</body>
</html> 